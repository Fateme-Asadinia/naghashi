<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نقاشی کودک — ارائه‌شده از فاطمه اسدی‌نیا</title>

  <!-- فونت فارسی -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1: #e8f7ff;
      --panel: #ffffff;
      --accent: #2b8cff; /* آبی */
      --accent2: #ffd166; /* زرد */
      --muted: #546070;
      --kid-font: "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:var(--kid-font);background:linear-gradient(180deg,#f7fbff 0%,var(--bg1) 100%);
      color:#123;direction:rtl;display:flex;flex-direction:column;align-items:center;
    }

    header{
      width:100%;max-width:1150px;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#4faaff);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px;box-shadow:0 10px 18px rgba(43,140,255,0.18)
    }
    .title{font-size:18px;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted)}

    main{width:100%;max-width:1150px;padding:10px;display:flex;gap:14px;align-items:flex-start}
    /* toolbar */
    .tools{width:280px;background:var(--panel);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(18,40,80,0.06)}
    .tools h3{margin:0 0 10px 0;font-size:14px;color:var(--muted)}
    .big-btn{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;margin:8px 0;cursor:pointer;border:2px solid transparent;background:linear-gradient(180deg,#fff,#f6fbff);font-size:15px}
    .big-btn.active{border-color:var(--accent);box-shadow:0 8px 18px rgba(43,140,255,0.12)}
    .palette{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .color-swatch{width:40px;height:40px;border-radius:10px;cursor:pointer;border:3px solid #fff;box-shadow:0 6px 10px rgba(2,6,23,0.06)}
    .size-row{display:flex;align-items:center;gap:8px;margin-top:8px}
    .small{padding:8px 10px;border-radius:10px;background:linear-gradient(180deg,#fff,#f0f8ff);border:none;cursor:pointer;font-weight:600}
    .muted{color:var(--muted);font-size:13px}

    /* canvas */
    .canvas-wrap{flex:1;background:var(--panel);border-radius:14px;padding:16px;display:flex;flex-direction:column;align-items:center;box-shadow:0 10px 30px rgba(18,40,80,0.06)}
    .stage{width:100%;max-width:820px;background:linear-gradient(180deg,#ffffff,#fbfeff);border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:12px;border:3px solid rgba(43,140,255,0.04)}
    canvas{background:#ffffff;border-radius:8px;touch-action:none;display:block;max-width:100%;height:auto}
    .controls-top{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .hint{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

    .size-btn{padding:8px 10px;border-radius:10px;border:2px solid transparent;background:#f6fbff;cursor:pointer}
    .size-btn.selected{border-color:var(--accent);background:linear-gradient(180deg, #ffffff, #f0f9ff)}

    @media (max-width:930px){
      main{flex-direction:column;padding:10px}
      .tools{width:100%}
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">نقش</div>
    <div>
      <div class="title">نقاشی کودک</div>
      <div class="subtitle">ارائه‌شده از <strong>فاطمه اسدی‌نیا</strong></div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button id="downloadBtn" class="small">💾 دانلود PNG</button>
    <button id="shareBtn" class="small" title="اشتراک‌گذاری">📤 اشتراک (واتساپ/به‌اشتراک‌گذاری)</button>
    <button id="clearBtn" class="small">🧽 پاک کردن</button>
  </div>
</header>

<main>
  <aside class="tools" aria-label="ابزارها">
    <h3>ابزارها</h3>

    <div id="brushBtn" class="big-btn active" data-tool="brush">✏️ قلم</div>
    <div id="eraserBtn" class="big-btn" data-tool="eraser">🧽 پاک‌کن</div>
    <div id="textBtn" class="big-btn" data-tool="text">🔤 متن فارسی</div>
    <div id="stampBtn" class="big-btn" data-tool="stamp">⭐ استامپ</div>

    <h3 style="margin-top:12px">رنگ‌ها</h3>
    <div class="palette" id="palette"></div>

    <h3 style="margin-top:10px">اندازه قلم</h3>
    <div class="size-row">
      <input id="sizeRange" type="range" min="1" max="60" value="6" style="flex:1">
      <div id="sizeLabel" style="min-width:44px;text-align:center">6</div>
    </div>

    <h3 style="margin-top:12px">اندازه بوم</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
      <button class="size-btn selected" data-w="400" data-h="600">موبایل (400×600)</button>
      <button class="size-btn" data-w="800" data-h="600">تبلت (800×600)</button>
      <button class="size-btn" data-w="900" data-h="600">دسکتاپ (900×600)</button>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="undoBtn" class="small">↩️ بازگشت</button>
      <button id="downloadMini" class="small">📥 دانلود کوچک</button>
    </div>

    <div style="margin-top:12px;color:var(--muted);font-size:13px">برای نوشتن متن: ابزار متن را انتخاب کن و سپس روی بوم یک‌بار تپ/کلیک کن.</div>
  </aside>

  <section class="canvas-wrap">
    <div class="controls-top">
      <div class="muted">ابزار: <span id="currentTool">قلم</span></div>
      <div style="flex:1"></div>
      <div class="muted">رنگ فعلی: <span id="currentColorBox" style="display:inline-block;width:18px;height:18px;border-radius:6px;border:2px solid #fff;vertical-align:middle;margin-left:6px"></span></div>
    </div>

    <div class="stage">
      <canvas id="paintCanvas" width="900" height="600"></canvas>
    </div>

    <div class="hint">ابزار را انتخاب کن و با انگشت یا ماوس طراحی کن. روی موبایل از گزینهٔ اشتراک برای فرستادن تصویر به واتساپ استفاده کن.</div>
  </section>
</main>

<input id="textInput" type="text" style="position:fixed;right:-9999px;opacity:0">

<script>
(function(){
  const canvas = document.getElementById('paintCanvas');
  const ctx = canvas.getContext('2d', {alpha:true});
  ctx.direction = 'rtl';
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';

  // UI refs
  const btns = {
    brush: document.getElementById('brushBtn'),
    eraser: document.getElementById('eraserBtn'),
    text: document.getElementById('textBtn'),
    stamp: document.getElementById('stampBtn')
  };
  const sizeRange = document.getElementById('sizeRange');
  const sizeLabel = document.getElementById('sizeLabel');
  const paletteEl = document.getElementById('palette');
  const currentToolLabel = document.getElementById('currentTool');
  const currentColorBox = document.getElementById('currentColorBox');
  const downloadBtn = document.getElementById('downloadBtn');
  const downloadMini = document.getElementById('downloadMini');
  const shareBtn = document.getElementById('shareBtn');
  const clearBtn = document.getElementById('clearBtn');
  const undoBtn = document.getElementById('undoBtn');

  // state
  let tool = 'brush';
  let drawing = false;
  let brushColor = '#0b66ff';
  let brushSize = parseInt(sizeRange.value,10) || 6;
  let lastPos = {x:0,y:0};
  const undoStack = [];
  const UNDO_LIMIT = 30;

  // palette (kid friendly)
  const palette = ['#0b66ff','#ffd166','#ff8fab','#7bd389','#46c7f0','#ffb86b','#6b6bff','#ff6b6b','#2ecc71','#8e44ad','#222','#ffffff'];
  function buildPalette(){
    paletteEl.innerHTML = '';
    palette.forEach(c=>{
      const d = document.createElement('div');
      d.className = 'color-swatch';
      d.style.background = c;
      d.addEventListener('click', ()=>{ brushColor = c; currentColorBox.style.background = c; });
      paletteEl.appendChild(d);
    });
    currentColorBox.style.background = brushColor;
  }
  buildPalette();

  // set canvas size helper (keeps content centered)
  function setCanvasSize(w,h, pushHistory=true){
    if(pushHistory) pushUndo();
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width; tmp.height = canvas.height;
    tmp.getContext('2d').drawImage(canvas,0,0);
    canvas.width = w; canvas.height = h;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const img = new Image();
    img.onload = function(){
      const scale = Math.min(canvas.width/tmp.width || 1, canvas.height/tmp.height || 1);
      const dw = tmp.width*scale, dh = tmp.height*scale;
      const dx = (canvas.width - dw)/2, dy = (canvas.height - dh)/2;
      ctx.drawImage(tmp, 0,0, tmp.width, tmp.height, dx, dy, dw, dh);
    };
    img.src = tmp.toDataURL();
  }

  // detect default size (mobile vs desktop)
  function detectDefaultSize(){
    if(window.innerWidth <= 480) return {w:400,h:600};
    if(window.innerWidth <= 900) return {w:800,h:600};
    return {w:900,h:600};
  }
  const dsize = detectDefaultSize();
  setCanvasSize(dsize.w, dsize.h, false);

  // size buttons
  document.querySelectorAll('.size-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      const w = parseInt(btn.dataset.w,10), h = parseInt(btn.dataset.h,10);
      setCanvasSize(w,h,true);
    });
  });

  // undo stack
  function pushUndo(){
    try{
      if(undoStack.length >= UNDO_LIMIT) undoStack.shift();
      undoStack.push(canvas.toDataURL('image/png'));
    }catch(e){ console.warn(e); }
  }
  function doUndo(){
    if(!undoStack.length) return;
    const data = undoStack.pop();
    const img = new Image();
    img.onload = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
    img.src = data;
  }

  // initial clear (white)
  function clearCanvas(push=true){
    if(push) pushUndo();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  clearCanvas(false);
  pushUndo();

  // tool switching
  function setTool(t){
    tool = t;
    Object.values(btns).forEach(b=>b.classList.remove('active'));
    if(btns[t]) btns[t].classList.add('active');
    const names = {brush:'قلم', eraser:'پاک‌کن', text:'متن', stamp:'استامپ'};
    currentToolLabel.textContent = names[t] || t;
  }
  setTool('brush');
  Object.keys(btns).forEach(k=>{ btns[k].addEventListener('click', ()=>setTool(k)); });

  // brush size
  sizeRange.addEventListener('input', ()=>{ brushSize = parseInt(sizeRange.value,10); sizeLabel.textContent = brushSize; });

  // drawing handlers
  function getPos(evt){
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  canvas.addEventListener('pointerdown', (e)=>{
    e.preventDefault();
    const p = getPos(e);
    lastPos = p;
    if(tool === 'text'){ placeTextAt(p.x,p.y); return; }
    if(tool === 'stamp'){ placeStamp(p.x,p.y); return; }
    drawing = true;
    pushUndo();
    ctx.beginPath();
    ctx.moveTo(p.x,p.y);
  });
  canvas.addEventListener('pointermove', (e)=>{
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    if(tool === 'eraser'){
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = brushSize * 2;
      ctx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.lineWidth = brushSize;
      ctx.strokeStyle = brushColor;
    }
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    lastPos = p;
  });
  canvas.addEventListener('pointerup', (e)=>{ drawing=false; ctx.closePath(); ctx.globalCompositeOperation='source-over'; });
  canvas.addEventListener('pointerleave', ()=>{ drawing=false; ctx.closePath(); ctx.globalCompositeOperation='source-over'; });
  canvas.addEventListener('dblclick', (e)=>{ const p = getPos(e); placeTextAt(p.x,p.y); });

  // place text (prompt)
  function placeTextAt(x,y){
    const txt = prompt('متن فارسی را وارد کنید:', 'سلام');
    if(!txt) return;
    pushUndo();
    ctx.save();
    const size = Math.max(12, brushSize*4);
    ctx.font = `${size}px Vazirmatn, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.direction = 'rtl';
    ctx.lineWidth = Math.max(2, Math.round(size*0.12));
    ctx.strokeStyle = '#ffffff';
    ctx.strokeText(txt, x, y);
    ctx.fillStyle = brushColor;
    ctx.fillText(txt, x, y);
    ctx.restore();
  }

  // star svg stamp (inline)
  const starSVG = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><polygon points="128,20 158,100 244,100 174,154 198,236 128,182 58,236 82,154 12,100 98,100" fill="#ffd166"/></svg>');
  const starDataURL = 'data:image/svg+xml;utf8,' + starSVG;

  function placeStamp(x,y){
    pushUndo();
    const size = Math.max(28, brushSize * 8);
    ctx.save();
    ctx.font = `${size}px Vazirmatn, sans-serif`;
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    ctx.fillStyle = brushColor;
    ctx.fillText('⭐', x, y);
    ctx.restore();
    const img = new Image();
    img.onload = function(){
      const s = Math.max(24, brushSize*6);
      ctx.drawImage(img, x - s/2, y - s/2, s, s);
    };
    img.src = starDataURL;
  }

  // download (with white bg)
  function download(name){
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width; tmp.height = canvas.height;
    const tctx = tmp.getContext('2d');
    tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,tmp.width,tmp.height);
    tctx.drawImage(canvas,0,0);
    tmp.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name || ('persian_paint_' + Date.now() + '.png');
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }, 'image/png');
  }

  function downloadSmall(){
    const small = document.createElement('canvas');
    const sw = Math.min(800, canvas.width);
    const scale = sw / canvas.width;
    small.width = Math.round(canvas.width * scale);
    small.height = Math.round(canvas.height * scale);
    const sctx = small.getContext('2d');
    sctx.fillStyle = '#ffffff'; sctx.fillRect(0,0,small.width,small.height);
    sctx.drawImage(canvas, 0,0, small.width, small.height);
    small.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'persian_paint_small_' + Date.now() + '.png';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }, 'image/png');
  }

  // share: try Web Share API with files (mobile best), fallback -> WhatsApp web with message
  async function shareImage(){
    try{
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      const file = new File([blob], 'persian_paint_' + Date.now() + '.png', {type:'image/png'});
      if(navigator.canShare && navigator.canShare({files: [file]})){
        await navigator.share({
          files: [file],
          title: 'نقاشی من',
          text: 'نقاشی ساخته شده با نقاشی کودک — ارائه‌شده از فاطمه اسدی‌نیا'
        });
        return;
      }
      if(navigator.clipboard && navigator.clipboard.write){
        try{
          await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
          alert('تصویر به کلیپ‌بورد کپی شد — حالا آن را در واتساپ یا جای دیگر پیست کن.');
          return;
        }catch(err){}
      }
      const msg = encodeURIComponent('این نقاشی را با برنامهٔ نقاشی کودک (ارائه‌شده از فاطمه اسدی‌نیا) ساختم. لطفاً تصویر را دانلود و در واتساپ آپلود کنید.');
      const waUrl = 'https://wa.me/?text=' + msg;
      window.open(waUrl, '_blank');
      alert('به دلیل محدودیت مرورگر/دسکتاپ، لطفاً تصویر را دانلود و سپس در واتساپ آپلود کن.');
    }catch(e){
      console.error('share error', e);
      alert('خطا در اشتراک‌گذاری: ' + (e.message || e));
    }
  }

  // attach UI
  downloadBtn.addEventListener('click', ()=>download());
  downloadMini.addEventListener('click', ()=>downloadSmall());
  shareBtn.addEventListener('click', ()=>shareImage());
  clearBtn.addEventListener('click', ()=>{ if(confirm('پاک شدن کل نقاشی؟')) clearCanvas(true); });
  undoBtn.addEventListener('click', ()=>doUndo());

  // keyboard shortcuts (desktop)
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key === 'z'){ doUndo(); }
    if(e.ctrlKey && e.key === 's'){ e.preventDefault(); download(); }
  });

  // initial UI values
  sizeLabel.textContent = brushSize;
  currentColorBox.style.background = brushColor;

  // expose for debugging
  window._persianPaint = { canvas, ctx, download, shareImage, clearCanvas, pushUndo, doUndo };

})();
</script>

</body>
</html>